<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>webrtc-sdk room/multitrack sample</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
      video { width: 320px; height: 180px; background: #000; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
      fieldset { margin-top: 12px; }
    </style>
  </head>
  <body>
    <h2>Room/Multitrack Sample (TS v2)</h2>
    <div class="grid" style="margin-bottom:12px;">
      <div>
        <label>Local</label>
        <video id="local" autoplay playsinline muted></video>
      </div>
    </div>
    <div>
      <input id="roomId" placeholder="room id" />
      <input id="streamId" placeholder="(optional) my stream id" />
      <button id="joinRoom">Join Room</button>
      <button id="leaveRoom" disabled>Leave Room</button>
    </div>

    <fieldset>
      <legend>Controls</legend>
      <div style="margin-bottom:8px;">
        <button id="turnOffCam">Turn off Camera</button>
        <button id="turnOnCam">Turn on Camera</button>
        <button id="muteMic">Mute Mic</button>
        <button id="unmuteMic">Unmute Mic</button>
      </div>
      <input id="mainTrackId" placeholder="main track id" />
      <input id="trackId" placeholder="sub track id" />
      <button id="enableTrack">Enable Track</button>
      <button id="disableTrack">Disable Track</button>
      <input id="qualityHeight" placeholder="height or 'auto'" />
      <button id="forceQuality">Force Quality</button>
      <div style="margin-top:8px;">
        <input id="selEnable" placeholder="enableTracks (comma separated)" />
        <label><input type="checkbox" id="selDisableDefault" /> disableTracksByDefault</label>
        <button id="playSelective">Play Selective</button>
      </div>
    </fieldset>

    <div class="grid" id="videos"></div>
    <pre id="log"></pre>

    <script type="module">
      import { WebRTCClient, getWebSocketURL, generateRandomString } from './js/index.js';

      const roomIdEl = document.getElementById('roomId');
      const streamIdEl = document.getElementById('streamId');
      const joinBtn = document.getElementById('joinRoom');
      const leaveBtn = document.getElementById('leaveRoom');
      const mainTrackEl = document.getElementById('mainTrackId');
      const trackIdEl = document.getElementById('trackId');
      const enableTrackBtn = document.getElementById('enableTrack');
      const disableTrackBtn = document.getElementById('disableTrack');
      const qualityEl = document.getElementById('qualityHeight');
      const forceQualityBtn = document.getElementById('forceQuality');
      const turnOffCamBtn = document.getElementById('turnOffCam');
      const turnOnCamBtn = document.getElementById('turnOnCam');
      const muteMicBtn = document.getElementById('muteMic');
      const unmuteMicBtn = document.getElementById('unmuteMic');
      const videos = document.getElementById('videos');
      const selEnable = document.getElementById('selEnable');
      const selDisableDefault = document.getElementById('selDisableDefault');
      const playSelectiveBtn = document.getElementById('playSelective');
      const logEl = document.getElementById('log');
      const local = document.getElementById('local');

      const websocketURL = getWebSocketURL(window.location);
      const adaptor = new WebRTCClient({ websocketURL, mediaConstraints: { audio: true, video: true }, localVideo: local });

      function log(msg) { logEl.textContent += msg + '\n'; }

      adaptor.on('initialized', () => log('initialized'));
      adaptor.on('room_joined', (o) => log('room_joined: ' + JSON.stringify(o)));
      adaptor.on('room_left', (o) => log('room_left: ' + JSON.stringify(o)));
      adaptor.on('room_information', (o) => log('room_information: ' + JSON.stringify(o)));
      adaptor.on('broadcast_object', (o) => log('broadcast_object: ' + JSON.stringify(o)));
      adaptor.on('publish_started', ({ streamId }) => log('publish_started: ' + streamId));
      adaptor.on('play_started', ({ streamId }) => log('play_started: ' + streamId));
      adaptor.on('error', (e) => log('error: ' + e.error));

      adaptor.on('newTrackAvailable', ({ stream }) => {
        // Create a video for each new stream
        const el = document.createElement('video');
        el.autoplay = true; el.playsInline = true; el.controls = true;
        el.srcObject = stream;
        videos.appendChild(el);
      });

      joinBtn.onclick = async () => {
        const roomId = roomIdEl.value.trim() || 'room_' + generateRandomString(6);
        let streamId = streamIdEl.value.trim();
        if (!streamId) {
          streamId = 'user_' + generateRandomString(6);
          streamIdEl.value = streamId;
        }
        try {
          await adaptor.ready();
          // publish my stream and play the room main track like v1 samples
          await adaptor.publish(streamId);
          await adaptor.play(roomId);
          await adaptor.joinRoom({ roomId, streamId });
          leaveBtn.disabled = false;
          log('joined room ' + roomId + ' as ' + streamId);
        } catch (e) {
          log('join failed: ' + (e && e.message ? e.message : e));
        }
      };
      leaveBtn.onclick = async () => {
        const roomId = roomIdEl.value.trim();
        const streamId = streamIdEl.value.trim() || undefined;
        try {
          await adaptor.leaveRoom(roomId, streamId);
        } catch {}
        if (streamId) adaptor.stop(streamId);
        if (roomId) adaptor.stop(roomId);
        leaveBtn.disabled = true;
      };

      enableTrackBtn.onclick = () => {
        adaptor.enableTrack(mainTrackEl.value.trim(), trackIdEl.value.trim(), true);
      };
      disableTrackBtn.onclick = () => {
        adaptor.enableTrack(mainTrackEl.value.trim(), trackIdEl.value.trim(), false);
      };
      forceQualityBtn.onclick = () => {
        const h = qualityEl.value.trim();
        adaptor.forceStreamQuality(mainTrackEl.value.trim(), h === 'auto' ? 'auto' : Number(h));
      };
      turnOffCamBtn.onclick = () => adaptor.turnOffLocalCamera();
      turnOnCamBtn.onclick = () => adaptor.turnOnLocalCamera();
      muteMicBtn.onclick = () => adaptor.muteLocalMic();
      unmuteMicBtn.onclick = () => adaptor.unmuteLocalMic();

      playSelectiveBtn.onclick = async () => {
        const list = selEnable.value.trim() ? selEnable.value.trim().split(',').map(s => s.trim()) : [];
        await adaptor.playSelective({
          streamId: mainTrackEl.value.trim(),
          enableTracks: list,
          disableTracksByDefault: !!selDisableDefault.checked,
        });
      };
    </script>
  </body>
  </html>


