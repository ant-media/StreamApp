<!DOCTYPE html>
<html>
<head>
    <title>WHEP Test</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>WHEP Test Player</h1>
    <video id="video" autoplay playsinline controls style="width: 640px; height: 360px;"></video>
    
    <div>
        <input type="text" id="streamId" placeholder="Stream ID" value="stream1">
        <button id="startPlaying">Start Playing</button>
        <button id="stopPlaying">Stop Playing</button>
    </div>
    
    <script type="text/javascript">
        const video = document.getElementById('video');
        const streamIdInput = document.getElementById('streamId');
        let whepSession = null;
        
        document.getElementById('startPlaying').addEventListener('click', async () => {
            const streamId = streamIdInput.value;
            
            try {
                // Create a new RTCPeerConnection
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }]
                });
                
                // Add event listeners
                pc.ontrack = (event) => {
                    console.log('Received track', event);
                    if (event.track.kind === 'video' || event.track.kind === 'audio') {
                        video.srcObject = event.streams[0];
                    }
                };
                
                pc.onicecandidate = ({candidate}) => {
                    if (!candidate) {
                        // When ICE gathering is complete, send the offer to the server
                    }
                };
                
                // Add transceivers for receiving audio and video
                pc.addTransceiver('audio', {direction: 'recvonly'});
                pc.addTransceiver('video', {direction: 'recvonly'});
                
                // Create an offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                console.log("Offer created: ", offer);
                console.log("Offer local description: ", pc.localDescription);
                console.log("*********************12313131231313 *********************");
                
                // Wait for ICE gathering to complete
                await new Promise((resolve) => {
                    if (pc.iceGatheringState === 'complete') {
                        resolve();
                    } else {
                        pc.addEventListener('icegatheringstatechange', function onStateChange() {
                            if (pc.iceGatheringState === 'complete') {
                                pc.removeEventListener('icegatheringstatechange', onStateChange);
                                resolve();
                            }
                        });
                    }
                });
                
                sendWhepOffer();
                
                async function sendWhepOffer() {
                    try {
                        console.log("Sending Whep offer");
                        
                        // Send the offer to the server in a single POST request
                        const response = await fetch(`http://localhost:5080/LiveApp/whep/${streamId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/sdp'
                            },
                            body: pc.localDescription.sdp
                        });
                        
                        if (!response.ok) { 
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log("Whep offer was successfully sent");
                        
                        // Get the ETag header which contains the session ID
                        const eTag = response.headers.get('ETag');
                        whepSession = { pc, streamId, eTag };

                        console.log("ETag received: ", eTag);

                        // Get the SDP answer from the response
                        const answerSdp = await response.text();
                        console.log("Answer SDP received: ", answerSdp);

                        // Create and set the remote description with the answer from the server
                        const remoteDesc = new RTCSessionDescription({
                            type: 'answer',
                            sdp: answerSdp
                        });

                        await pc.setRemoteDescription(remoteDesc);
                        console.log('WHEP connection established');

                    } catch (error) {
                        console.error('Error establishing WHEP connection:', error);
                    }
                }
            } catch (error) {
                console.error('Error setting up WebRTC:', error);
            }
        });
        
        document.getElementById('stopPlaying').addEventListener('click', async () => {
            if (whepSession) {
                try {
                    // Send DELETE request to terminate the session
                    await fetch(`http://localhost:5080/LiveApp/whep/${whepSession.streamId}/${whepSession.eTag}`, {
                        method: 'DELETE'
                    });
                    
                    // Close the peer connection
                    whepSession.pc.close();
                    whepSession = null;
                    
                    // Clear the video
                    video.srcObject = null;
                    
                    console.log('WHEP session terminated');
                } catch (error) {
                    console.error('Error terminating WHEP session:', error);
                }
            }
        });
    </script>
</body>
</html>