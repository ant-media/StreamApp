<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Samples > New Publish/Play (join/ready)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/external/bootstrap4/bootstrap.min.css">
  <link rel="stylesheet" href="css/samples.css" />
</head>
<body>
  <div class="container">
    <div class="header clearfix">
      <div class="row">
        <h3 class="col text-muted" id="title"><a href="samples.html">WebRTC Samples</a> > New SDK Demo</h3>
      </div>
    </div>

    <div class="jumbotron">
      <div class="row">
        <div class="col-sm-6">
          <label>Local</label>
          <video id="localVideo" autoplay muted playsinline class="w-100" style="background:#000;height:240px"></video>
        </div>
        <div class="col-sm-6">
          <label>Remote</label>
          <video id="remoteVideo" autoplay playsinline class="w-100" style="background:#000;height:240px"></video>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-sm-6">
          <input type="text" class="form-control" id="streamId" placeholder="Type stream ID" />
        </div>
        <div class="col-sm-3">
          <select id="role" class="form-control">
            <option value="publisher">Publisher</option>
            <option value="viewer">Viewer</option>
          </select>
        </div>
        <div class="col-sm-3 text-right">
          <button id="startBtn" class="btn btn-primary">Start</button>
          <button id="stopBtn" class="btn btn-secondary" disabled>Stop</button>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-sm-12">
          <span class="badge badge-secondary" id="statusText">Status: Idle</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { WebRTCAdaptor } from "./js/webrtc_adaptor.js";
    import { getUrlParameter } from "./js/fetch.stream.js";
    import { getWebSocketURL, generateRandomString } from "./js/utility.js";

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const streamIdInput = document.getElementById("streamId");
    const roleSelect = document.getElementById("role");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusText = document.getElementById("statusText");

    // Parse params similar to index.html
    const debug = getUrlParameter("debug") || false;
    const token = getUrlParameter("token");
    const subscriberId = getUrlParameter("subscriberId");
    const subscriberCode = getUrlParameter("subscriberCode");
    const streamName = getUrlParameter("streamName");
    const mainTrack = getUrlParameter("mainTrack");
    const metaData = getUrlParameter("metaData");
    const playType = getUrlParameter("play");

    // Init defaults
    let initialRole = getUrlParameter("role") || (playType ? "viewer" : "publisher");
    roleSelect.value = initialRole;

    let id = getUrlParameter("id") || getUrlParameter("name") || ("streamId_" + generateRandomString(9));
    streamIdInput.value = id;

    // websocket URL generation like samples
    const rtmpForward = getUrlParameter("rtmpForward");
    const websocketURL = getWebSocketURL(location, rtmpForward);

    let wa = null;
    let currentStreamId = null;

    function setStatus(text, cls = "secondary") {
      statusText.className = "badge badge-" + cls;
      statusText.textContent = "Status: " + text;
    }

    function bindEvents(instance) {
      instance.on("initialized", () => setStatus("Initialized", "info"));
      instance.on("publish_started", () => { setStatus("Publishing", "success"); stopBtn.disabled = false; });
      instance.on("publish_finished", () => { setStatus("Stopped", "secondary"); stopBtn.disabled = true; });
      instance.on("play_started", () => { setStatus("Playing", "success"); stopBtn.disabled = false; });
      instance.on("play_finished", () => { setStatus("Stopped", "secondary"); stopBtn.disabled = true; });
      instance.on("error", ({ error }) => { setStatus("Error: " + error, "danger"); });
    }

    function createAdaptor(isPlayMode) {
      wa = new WebRTCAdaptor({
        websocket_url: websocketURL,
        localVideoElement: localVideo,
        remoteVideoElement: remoteVideo,
        isPlayMode: isPlayMode,
        mediaConstraints: { video: true, audio: true },
        debug: debug,
      });
      bindEvents(wa);
    }

    async function start() {
      const role = roleSelect.value;
      currentStreamId = streamIdInput.value || ("streamId_" + generateRandomString(9));

      // Recreate adaptor if role changed (play mode avoids gUM)
      const needPlayMode = role === "viewer";
      if (!wa || (!!wa.isPlayMode !== needPlayMode)) {
        createAdaptor(needPlayMode);
      }

      setStatus("Connecting...", "info");
      await wa.ready();

      await wa.join({
        role: role,
        streamId: currentStreamId,
        token: token,
        subscriberId: subscriberId,
        subscriberCode: subscriberCode,
        streamName: streamName,
        mainTrack: mainTrack,
        metaData: metaData,
        timeoutMs: 20000,
      });

      startBtn.disabled = true;
      stopBtn.disabled = false;
    }

    function stop() {
      if (wa && currentStreamId) {
        wa.stop(currentStreamId);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        setStatus("Stopped", "secondary");
      }
    }

    startBtn.addEventListener("click", start);
    stopBtn.addEventListener("click", stop);

    // Auto-start if query params provided
    if (getUrlParameter("autostart") === "true") {
      start();
    }
  </script>
</body>
</html> 